#!/bin/sh

# git upstream - figure out ref of upstream branch

root="`git root`"
if [ -d "$root/.git/svn" ]; then
    svn_branch=$(
        git svn info | \
            perl -lne '
                /^URL: (.+)/ and $u = $1;
                if (/^Repository Root: (.+)/) {
                    $r = $1;
                    $u =~ s!\Q$r/!!;
                    print $u
                }'
        )
    # Need to apply refspec transformation;
    #svn_branches_map=$( git config svn-remote.svn.branches )
    # for now we just assume standard layout and cheat.
    upstream=remotes/${svn_branch#branches/}
else
    upstream=$(git config "branch.`git head`.remote")
    if [ -z "$upstream" ]; then
        upstream=origin
    fi
fi

if ! git rev-parse "$upstream" >/dev/null 2>&1; then
    echo "Couldn't figure out upstream ref; aborting." >&2
    exit 1
fi

echo "$upstream"
