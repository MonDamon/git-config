#!/bin/sh

# git upstream - figure out ref of upstream branch

get_svn_upstream () {
    if ! [ -d "$root/.git/svn" ]; then
        return 1
    fi

    if [ `ls "$root/.git/svn" | wc -l` == 1 ]; then
        if upstream=`cd $root/.git/svn && ls`; then
            return 0
        else
            echo "WARNING: cd $root/.git/svn && ls failed" >&2
        fi
    fi

    if ! svn_info=$( git svn info 2>&1 ); then
        return 1
    fi

    if echo "$svn_info" | grep -q 'Unable to determine upstream SVN info'; then
        return 1
    fi

    svn_branch=$(
        echo "$svn_info" |
            perl -lne '
                /^URL: (.+)/ and $u = $1;
                if (/^Repository Root: (.+)/) {
                    $r = $1;
                    $u =~ s!\Q$r/!!;

                    # This bit required since git svn info changed to including
                    # the subpath of the cwd in the URL (somewhere in between 1.6.0
                    # and 1.7.1):
                    ($subdir = `git prefix`) =~ s!/\n$!!;
                    $u =~ s!/$subdir$!!; 

                    print $u
                }'
    )
    # Need to apply refspec transformation;
    #svn_branches_map=$( git config svn-remote.svn.branches )
    # for now we just assume standard layout and cheat.
    upstream="remotes/${svn_branch#branches/}"
    return 0
}

get_upstream () {
    # If the upstream is explicitly specified in config, we honor that.
    localhead="`git head`"
    remotebranchconf="branch.$localhead.remote"
    upstream=$(git config "$remotebranchconf")
    if [ -n "$upstream" ]; then
        if git rev-parse "$upstream" >/dev/null 2>&1; then
            return
        fi
        upstream="$upstream/$localhead"
        if git rev-parse "$upstream" >/dev/null 2>&1; then
            return
        fi
        echo "Couldn't determine upstream branch from $remotebranchconf = $upstream" >&2
        exit 1
    fi

    if ! get_svn_upstream; then
        # Need to apply refspec transformation; for now we just guess
        # that the upstream was a git repository, and that the local
        # and remote branches have the same name.  'origin' is just
        # the name that git uses by default to refer to the
        # repository that you cloned from.
        upstream=origin/$localhead
    fi
}

root="`git root`"
if ! [ -d "$root" ]; then
    exit 1
fi

get_upstream

if ! git rev-parse "$upstream" >/dev/null 2>&1; then
    cat <<EOF >&2
Best guess '$upstream' was invalid.
Maybe you should do:

   git config branch.$localhead.remote \$remote

Couldn't figure out upstream ref; aborting.
EOF
    exit 1
fi

echo "$upstream"
