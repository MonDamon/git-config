#!/bin/bash

commit_local_changes () {
    status=`git -c color.ui=always status -s "$@"`
    if [ -n "$status" ]; then
        echo "$status"
        echo
        if [ -n "$DISPLAY" ]; then
            echo "Launching git-gui; commit local changes before proceeding with sync ..."
            echo "Press Control-C to cancel"
            git gui
        else
            echo "\$DISPLAY not set so can't launch git-gui.  Launching $SHELL;"
            echo "please commit changes via CLI then exit the shell."
            $SHELL
        fi
    fi
}

detect_upstream () {
    head=`git head`
    if ! upstream=`git upstream`; then
        cat <<EOF

Remotes already set:
--------------------

`git remote -v`

Launching $SHELL; please set correct upstream for $head
then hit Control-D to continue ...
EOF
        $SHELL
    fi

    if ! upstream=`git upstream 2>/dev/null`; then
        echo 
        echo "Upstream still not set for $head; aborting." >&2
        exit 1
    fi
}

parse_upstream () {
    local upstream="$1"

    remote="${upstream%/*}"
    remote_branch="${upstream#*/}"
}

compare_with_upstream () {
    local upstream="$1"

    # http://stackoverflow.com/questions/2969214/git-programmatically-know-by-how-much-the-branch-is-ahead-behind-a-remote-branc

    set -- `git rev-list --count --left-right $upstream...HEAD`
    behind="$1"
    ahead="$2"
}

show_upstream_info () {
    git remote -v show -n "$1"
}

confirm_action () {
    action="$1"

    while true; do
        echo    "Enter 'y' to $action,"
        echo -n "      's' to skip, or Control-C to abort > "
        read answer
        case "$answer" in
            y) return 0 ;;
            s) return 1 ;;
        esac
    done
}

pull_from_upstream () {
    local upstream="$1"

    echo
    echo -e "\e[1;31m$head is behind $upstream by $behind commits:\e[0m"
    git log HEAD.."$upstream"

    echo
    confirm_action "pull missing commits from $upstream" || return

    args="$remote $remote_branch"
    echo "Running git pull $args ..."
    echo
    if ! git pull $args; then
        echo "git pull $args failed; aborting.  Please manually fix and re-run." >&2
        exit 1
    fi
}

push_to_upstream () {
    local upstream="$1"

    echo
    echo -e "\e[1;33m$head is ahead of $upstream by $ahead commits.\e[0m"
    git log "$upstream"..HEAD

    echo
    confirm_action "push new commits to $upstream" || return

    args="$remote $head"
    echo
    if ! git push $args; then
        echo "git push $args failed; aborting.  Please manually fix and re-run." >&2
        exit 1
    fi
}

final_check () {
    echo
    if git-wip; then
        echo -e "\e[1;31mUnresolved issues in $root:\e[0m"
        echo
        ggs
    else
        echo -e "\e[1;32mNo unresolved issues in $root :-)\e[0m"
    fi
}

sync_with_upstream () {
    local upstream="$1"

    parse_upstream "$upstream"

    echo
    echo "git fetch $remote"
    git fetch "$remote"
    echo
    compare_with_upstream "$upstream"
    show_upstream_info "$remote"

    if [ "$behind" != 0 ]; then
        pull_from_upstream "$upstream"
    fi

    if [ "$ahead" != 0 ]; then
        push_to_upstream "$upstream"
    fi
}

main () {
    root="`git root`"
    root="${root/$HOME/~}"

    commit_local_changes

    detect_upstream
    sync_with_upstream "$upstream"
    if [ "$upstream" != 'github' -a -n "`git config remote.github.url`" ]; then
        sync_with_upstream "github/$head"
    fi

    final_check
}

main
