#!/bin/bash

if ! which git >&/dev/null; then
    echo "git not found; aborting .cfg-post.d/git" >&2
    exit 1
fi

if which zsh >&/dev/null; then
  zsh -c zrec
fi

# too lazy to make separate cfgctl module with personal config
if [[ "$ZDOTUSER" == adam.spiers ]]; then
  git config --global user.name "Adam Spiers"
  # set user.email on a per-project basis
  git config --global user.signingkey 7A2F2DDC
fi

git config --global color.ui auto
git config --global color.pager true
git config --global color.diff auto

# Paging
#git config --global core.pager $PAGER
git config --global pager.diff-tree true

git config --global rebase.autosquash true

git config --global push.default >/dev/null || \
    git config --global push.default upstream

git config --global receive.denyCurrentBranch refuse

##############################################################################
# set up .gitignore from .cvsignore

git config --global core.excludesfile ~/.gitignore

# Don't autogenerate .gitignore any more; it's more flexible
# than .cvsignore format, and the latter is stable now anyway.

# if ! [ -e "$HOME/.cvsignore" ]; then
#     echo "WARNING: ~/.cvsignore not found, won't create ~/.gitignore." >&2
#     exit 1
# fi

# if [ -L ~/.gitignore ]; then
#   echo "ERROR: .gitignore is a symlink, won't overwrite" >&2
#   exit 1
# fi

# cat <<EOF > ~/.gitignore
# # Automatically generated by $0
# # on `date`
# # DO NOT EDIT!

# EOF

# sed 's/^#/\\#/g' ~/.cvsignore >> ~/.gitignore

. ~/lib/libhost.sh
read_localhost_nickname

for h in arctic coral; do
    if [ "$localhost_nickname" = $h ]; then
        git url-rewrite $h: /home/adam/
    else
        git url-rewrite $h: ssh://adam@$h.adamspiers.org/home/adam/
    fi
done

if [ "$localhost_nickname" = 'coral' ]; then
    git url-rewrite adamspiers.org: /home/adam/.srv/git/
else
    git url-rewrite adamspiers.org: ssh://adam@git.adamspiers.org/home/adam/.srv/git/
fi

git url-rewrite github:    git@github.com:aspiers/
git url-rewrite gitorious: git@gitorious.org:~aspiers/

git config --global sendemail.suppressfrom true
git config --global sendemail.smtpserver `which msmtp-personal`

# --envelope-sender=auto not needed with msmtp-personal which uses msmtp --read-envelope-from
#git config --global sendemail.envelopesender auto
